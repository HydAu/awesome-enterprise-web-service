machine:
  node:
    version: 5.11.0
  services:
    - docker
  environment:
    NODE_ENV: test
    SECRET: secret
    MYSQL_HOST: localhost
    MYSQL_PORT: 3306
    MYSQL_DATABASE: circle_test
    MYSQL_USERNAME: ubuntu
    REDIS_HOST: localhost
    REDIS_PORT: 6379
    REDIS_PARTITION: test

test:
  override:
    - |
        if [ master == $CIRCLE_BRANCH ]; then
          npm run test:coverage
        else
          npm run test
        fi
    # - curl --retry 10 --retry-delay 5 -v http://localhost:8080/api/healthcheck

deployment:
  hub:
    branch: master
    commands:
      - docker build -t kkemple/awesome-enterprise-web-service:$CIRCLE_SHA1 .
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - docker push kkemple/awesome-enterprise-web-service
